---
kind: pipeline
type: docker
name: coding-standard-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: server/apps/encryption

steps:
- name: coding-standard
  pull: always
  image: owncloudci/php:7.2
  commands:
  - make test-php-style

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

---
kind: pipeline
type: docker
name: coding-standard-php7.3

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: server/apps/encryption

steps:
- name: coding-standard
  pull: always
  image: owncloudci/php:7.3
  commands:
  - make test-php-style

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

---
kind: pipeline
type: docker
name: coding-standard-php7.4

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: server/apps/encryption

steps:
- name: coding-standard
  pull: always
  image: owncloudci/php:7.4
  commands:
  - make test-php-style

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

---
kind: pipeline
type: docker
name: phpstan-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: server/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: sqlite
    db_name: owncloud
    db_password: owncloud
    db_type: sqlite
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: phpstan
  pull: always
  image: owncloudci/php:7.2
  commands:
  - make test-php-phpstan

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

---
kind: pipeline
type: docker
name: phpunit-php7.2-sqlite

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: server/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: sqlite
    db_name: owncloud
    db_password: owncloud
    db_type: sqlite
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: phpunit-tests
  pull: always
  image: owncloudci/php:7.2
  commands:
  - make test-php-unit-dbg

- name: coverage-rename
  pull: always
  image: owncloudci/php:7.2
  commands:
  - mv tests/output/clover.xml tests/output/clover-phpunit-php7.2-sqlite.xml

- name: coverage-cache-1
  pull: always
  image: plugins/s3
  settings:
    access_key:
      from_secret: cache_s3_access_key
    bucket: cache
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    secret_key:
      from_secret: cache_s3_secret_key
    source: tests/output/clover-phpunit-php7.2-sqlite.xml
    strip_prefix: tests/output
    target: encryption/${DRONE_COMMIT}-${DRONE_BUILD_NUMBER}

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: phpunit-php7.2-mysql8.0

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: server/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: phpunit-tests
  pull: always
  image: owncloudci/php:7.2
  commands:
  - make test-php-unit-dbg

- name: coverage-rename
  pull: always
  image: owncloudci/php:7.2
  commands:
  - mv tests/output/clover.xml tests/output/clover-phpunit-php7.2-mysql8.0.xml

- name: coverage-cache-1
  pull: always
  image: plugins/s3
  settings:
    access_key:
      from_secret: cache_s3_access_key
    bucket: cache
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    secret_key:
      from_secret: cache_s3_secret_key
    source: tests/output/clover-phpunit-php7.2-mysql8.0.xml
    strip_prefix: tests/output
    target: encryption/${DRONE_COMMIT}-${DRONE_BUILD_NUMBER}

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: phpunit-php7.2-postgres9.4

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: server/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: postgres
    db_name: owncloud
    db_password: owncloud
    db_type: pgsql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: phpunit-tests
  pull: always
  image: owncloudci/php:7.2
  commands:
  - make test-php-unit-dbg

- name: coverage-rename
  pull: always
  image: owncloudci/php:7.2
  commands:
  - mv tests/output/clover.xml tests/output/clover-phpunit-php7.2-postgres9.4.xml

- name: coverage-cache-1
  pull: always
  image: plugins/s3
  settings:
    access_key:
      from_secret: cache_s3_access_key
    bucket: cache
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    secret_key:
      from_secret: cache_s3_secret_key
    source: tests/output/clover-phpunit-php7.2-postgres9.4.xml
    strip_prefix: tests/output
    target: encryption/${DRONE_COMMIT}-${DRONE_BUILD_NUMBER}

services:
- name: postgres
  pull: always
  image: postgres:9.4
  environment:
    POSTGRES_DB: owncloud
    POSTGRES_PASSWORD: owncloud
    POSTGRES_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: phpunit-php7.3-sqlite

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: server/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: sqlite
    db_name: owncloud
    db_password: owncloud
    db_type: sqlite
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.3
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: phpunit-tests
  pull: always
  image: owncloudci/php:7.3
  commands:
  - make test-php-unit

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: phpunit-php7.3-mysql8.0

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: server/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.3
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: phpunit-tests
  pull: always
  image: owncloudci/php:7.3
  commands:
  - make test-php-unit

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: phpunit-php7.3-postgres9.4

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: server/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: postgres
    db_name: owncloud
    db_password: owncloud
    db_type: pgsql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.3
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: phpunit-tests
  pull: always
  image: owncloudci/php:7.3
  commands:
  - make test-php-unit

services:
- name: postgres
  pull: always
  image: postgres:9.4
  environment:
    POSTGRES_DB: owncloud
    POSTGRES_PASSWORD: owncloud
    POSTGRES_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: phpunit-php7.4-sqlite

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: server/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: sqlite
    db_name: owncloud
    db_password: owncloud
    db_type: sqlite
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: phpunit-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - make test-php-unit

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: phpunit-php7.4-mysql8.0

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: server/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: phpunit-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - make test-php-unit

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: phpunit-php7.4-postgres9.4

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: server/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: postgres
    db_name: owncloud
    db_password: owncloud
    db_type: pgsql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: phpunit-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - make test-php-unit

services:
- name: postgres
  pull: always
  image: postgres:9.4
  environment:
    POSTGRES_DB: owncloud
    POSTGRES_PASSWORD: owncloud
    POSTGRES_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: sonar-analysis

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: server/apps/encryption

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer-install
  pull: always
  image: owncloudci/php:7.4
  commands:
  - make vendor
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: sqlite
    db_name: owncloud
    db_password: owncloud
    db_type: sqlite
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: sync-from-cache
  pull: always
  image: minio/mc:RELEASE.2020-12-18T10-53-53Z
  commands:
  - mkdir -p results
  - mc mirror cache/cache/encryption/${DRONE_COMMIT}-${DRONE_BUILD_NUMBER} results/
  environment:
    MC_HOST_cache:
      from_secret: cache_s3_connection_url

- name: list-coverage-results
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -l results

- name: sonarcloud-pr
  pull: always
  image: sonarsource/sonar-scanner-cli
  environment:
    SONAR_PULL_REQUEST_BASE: master
    SONAR_PULL_REQUEST_BRANCH: ${DRONE_SOURCE_BRANCH}
    SONAR_PULL_REQUEST_KEY: ${DRONE_COMMIT_REF}
    SONAR_SCANNER_OPTS: -Xdebug
    SONAR_TOKEN:
      from_secret: sonar_token
  when:
    event:
    - pull_request

- name: sonarcloud-master
  pull: always
  image: sonarsource/sonar-scanner-cli
  environment:
    SONAR_SCANNER_OPTS: -Xdebug
    SONAR_TOKEN:
      from_secret: sonar_token
  when:
    event:
      exclude:
      - pull_request

- name: purge-cache
  image: minio/mc:RELEASE.2020-12-18T10-53-53Z
  commands:
  - mc rm --recursive --force cache/cache/encryption/${DRONE_COMMIT}-${DRONE_BUILD_NUMBER}
  environment:
    MC_HOST_cache:
      from_secret: cache_s3_connection_url

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- phpunit-php7.2-sqlite
- phpunit-php7.2-mysql8.0
- phpunit-php7.2-postgres9.4
- phpunit-php7.3-sqlite
- phpunit-php7.3-mysql8.0
- phpunit-php7.3-postgres9.4
- phpunit-php7.4-sqlite
- phpunit-php7.4-mysql8.0
- phpunit-php7.4-postgres9.4

---
kind: pipeline
type: docker
name: cliEncryption-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-cli
  environment:
    BEHAT_SUITE: cliEncryption
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: cliEncryption-master-postgres9.4-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: postgres
    db_name: owncloud
    db_password: owncloud
    db_type: pgsql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-cli
  environment:
    BEHAT_SUITE: cliEncryption
    TEST_SERVER_URL: http://server

services:
- name: postgres
  pull: always
  image: postgres:9.4
  environment:
    POSTGRES_DB: owncloud
    POSTGRES_PASSWORD: owncloud
    POSTGRES_USER: owncloud

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: cliEncryption-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-cli
  environment:
    BEHAT_SUITE: cliEncryption
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: cliEncryption-latest-postgres9.4-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: postgres
    db_name: owncloud
    db_password: owncloud
    db_type: pgsql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-cli
  environment:
    BEHAT_SUITE: cliEncryption
    TEST_SERVER_URL: http://server

services:
- name: postgres
  pull: always
  image: postgres:9.4
  environment:
    POSTGRES_DB: owncloud
    POSTGRES_PASSWORD: owncloud
    POSTGRES_USER: owncloud

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiMasterKeys-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-api
  environment:
    BEHAT_SUITE: apiEncryption
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiMasterKeys-master-postgres9.4-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: postgres
    db_name: owncloud
    db_password: owncloud
    db_type: pgsql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-api
  environment:
    BEHAT_SUITE: apiEncryption
    TEST_SERVER_URL: http://server

services:
- name: postgres
  pull: always
  image: postgres:9.4
  environment:
    POSTGRES_DB: owncloud
    POSTGRES_PASSWORD: owncloud
    POSTGRES_USER: owncloud

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiMasterKeys-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-api
  environment:
    BEHAT_SUITE: apiEncryption
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiMasterKeys-latest-postgres9.4-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: postgres
    db_name: owncloud
    db_password: owncloud
    db_type: pgsql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-api
  environment:
    BEHAT_SUITE: apiEncryption
    TEST_SERVER_URL: http://server

services:
- name: postgres
  pull: always
  image: postgres:9.4
  environment:
    POSTGRES_DB: owncloud
    POSTGRES_PASSWORD: owncloud
    POSTGRES_USER: owncloud

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIMasterKey-master-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-webui
  environment:
    BEHAT_SUITE: webUIMasterKeyType
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIMasterKey-latest-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-webui
  environment:
    BEHAT_SUITE: webUIMasterKeyType
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiUserKeys-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-api
  environment:
    BEHAT_SUITE: apiEncryption
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiUserKeys-master-postgres9.4-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: postgres
    db_name: owncloud
    db_password: owncloud
    db_type: pgsql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-api
  environment:
    BEHAT_SUITE: apiEncryption
    TEST_SERVER_URL: http://server

services:
- name: postgres
  pull: always
  image: postgres:9.4
  environment:
    POSTGRES_DB: owncloud
    POSTGRES_PASSWORD: owncloud
    POSTGRES_USER: owncloud

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiUserKeys-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-api
  environment:
    BEHAT_SUITE: apiEncryption
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiUserKeys-latest-postgres9.4-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: postgres
    db_name: owncloud
    db_password: owncloud
    db_type: pgsql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-api
  environment:
    BEHAT_SUITE: apiEncryption
    TEST_SERVER_URL: http://server

services:
- name: postgres
  pull: always
  image: postgres:9.4
  environment:
    POSTGRES_DB: owncloud
    POSTGRES_PASSWORD: owncloud
    POSTGRES_USER: owncloud

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIUserKeys-master-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-webui
  environment:
    BEHAT_SUITE: webUIUserKeysType
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIUserKeys-latest-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-webui
  environment:
    BEHAT_SUITE: webUIUserKeysType
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-1-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 1
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-2-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 2
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-3-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 3
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-4-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 4
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-5-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 5
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-6-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 6
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-7-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 7
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-8-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 8
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-9-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 9
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-10-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 10
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-11-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 11
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-12-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 12
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-13-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 13
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-14-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 14
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-15-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 15
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-16-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 16
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-17-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 17
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-18-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 18
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-19-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 19
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-20-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 20
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-21-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 21
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-22-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 22
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-23-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 23
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-24-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 24
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-25-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 25
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-26-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 26
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-27-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 27
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-28-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 28
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-29-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 29
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-30-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 30
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-31-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 31
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-32-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 32
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-33-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 33
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-34-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 34
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-35-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 35
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-36-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 36
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-37-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 37
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-38-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 38
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-39-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 39
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-40-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 40
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-41-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 41
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-42-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 42
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-43-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 43
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-1-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 1
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-2-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 2
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-3-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 3
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-4-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 4
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-5-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 5
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-6-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 6
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-7-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 7
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-8-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 8
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-9-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 9
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-10-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 10
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-11-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 11
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-12-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 12
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-13-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 13
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-14-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 14
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-15-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 15
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-16-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 16
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-17-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 17
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-18-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 18
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-19-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 19
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-20-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 20
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-21-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 21
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-22-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 22
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-23-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 23
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-24-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 24
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-25-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 25
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-26-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 26
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-27-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 27
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-28-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 28
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-29-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 29
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-30-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 30
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-31-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 31
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-32-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 32
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-33-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 33
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-34-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 34
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-35-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 35
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-36-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 36
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-37-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 37
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-38-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 38
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-39-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 39
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-40-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 40
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-41-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 41
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-42-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 42
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreMKey-43-43-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 43
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-1-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 1
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-2-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 2
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-3-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 3
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-4-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 4
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-5-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 5
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-6-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 6
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-7-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 7
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-8-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 8
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-9-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 9
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-10-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 10
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-11-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 11
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-12-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 12
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-13-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 13
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-14-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 14
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-15-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 15
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-16-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 16
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-17-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 17
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-18-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 18
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-19-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 19
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-20-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 20
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-21-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 21
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-22-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 22
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-23-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 23
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-24-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 24
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-25-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 25
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-26-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 26
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-27-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 27
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-28-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 28
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-29-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 29
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-30-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 30
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-31-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 31
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-32-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 32
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-33-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 33
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-34-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 34
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-35-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 35
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-36-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 36
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-37-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 37
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-38-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 38
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-39-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 39
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-40-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 40
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-41-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 41
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-42-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 42
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-43-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 43
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-1-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 1
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-2-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 2
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-3-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 3
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-4-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 4
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-5-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 5
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-6-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 6
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-7-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 7
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-8-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 8
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-9-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 9
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-10-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 10
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-11-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 11
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-12-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 12
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-13-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 13
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-14-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 14
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-15-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 15
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-16-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 16
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-17-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 17
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-18-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 18
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-19-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 19
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-20-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 20
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-21-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 21
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-22-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 22
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-23-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 23
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-24-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 24
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-25-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 25
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-26-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 26
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-27-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 27
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-28-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 28
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-29-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 29
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-30-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 30
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-31-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 31
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-32-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 32
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-33-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 33
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-34-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 34
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-35-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 35
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-36-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 36
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-37-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 37
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-38-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 38
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-39-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 39
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-40-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 40
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-41-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 41
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-42-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 42
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: apiCoreUKey-43-43-latest-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 43
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 43
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: cliCoreMKey-3-1-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-cli
  environment:
    DIVIDE_INTO_NUM_PARTS: 3
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 1
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: cliCoreMKey-3-2-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-cli
  environment:
    DIVIDE_INTO_NUM_PARTS: 3
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 2
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: cliCoreMKey-3-3-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-cli
  environment:
    DIVIDE_INTO_NUM_PARTS: 3
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    RUN_PART: 3
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: cliCoreUKey-3-1-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-cli
  environment:
    DIVIDE_INTO_NUM_PARTS: 3
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 1
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: cliCoreUKey-3-2-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-cli
  environment:
    DIVIDE_INTO_NUM_PARTS: 3
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 2
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: cliCoreUKey-3-3-master-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-cli
  environment:
    DIVIDE_INTO_NUM_PARTS: 3
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    RUN_PART: 3
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreMKey-19-1-master-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 1
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreMKey-19-2-master-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 2
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreMKey-19-3-master-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 3
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreMKey-19-4-master-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 4
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreMKey-19-5-master-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 5
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreMKey-19-6-master-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 6
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreMKey-19-7-master-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 7
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreMKey-19-8-master-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 8
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreMKey-19-9-master-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 9
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreMKey-19-10-master-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 10
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreMKey-19-11-master-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 11
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreMKey-19-12-master-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 12
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreMKey-19-13-master-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 13
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreMKey-19-14-master-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 14
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreMKey-19-15-master-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 15
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreMKey-19-16-master-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 16
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreMKey-19-17-master-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 17
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreMKey-19-18-master-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 18
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreMKey-19-19-master-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 19
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreMKey-19-1-latest-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 1
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreMKey-19-2-latest-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 2
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreMKey-19-3-latest-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 3
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreMKey-19-4-latest-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 4
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreMKey-19-5-latest-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 5
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreMKey-19-6-latest-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 6
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreMKey-19-7-latest-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 7
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreMKey-19-8-latest-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 8
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreMKey-19-9-latest-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 9
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreMKey-19-10-latest-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 10
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreMKey-19-11-latest-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 11
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreMKey-19-12-latest-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 12
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreMKey-19-13-latest-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 13
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreMKey-19-14-latest-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 14
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreMKey-19-15-latest-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 15
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreMKey-19-16-latest-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 16
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreMKey-19-17-latest-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 17
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreMKey-19-18-latest-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 18
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreMKey-19-19-latest-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type masterkey --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: masterkey
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 19
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreUKey-19-1-master-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 1
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreUKey-19-2-master-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 2
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreUKey-19-3-master-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 3
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreUKey-19-4-master-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 4
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreUKey-19-5-master-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 5
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreUKey-19-6-master-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 6
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreUKey-19-7-master-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 7
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreUKey-19-8-master-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 8
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreUKey-19-9-master-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 9
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreUKey-19-10-master-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 10
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreUKey-19-11-master-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 11
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreUKey-19-12-master-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 12
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreUKey-19-13-master-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 13
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreUKey-19-14-master-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 14
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreUKey-19-15-master-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 15
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreUKey-19-16-master-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 16
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreUKey-19-17-master-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 17
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreUKey-19-18-master-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 18
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreUKey-19-19-master-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 19
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreUKey-19-1-latest-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 1
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreUKey-19-2-latest-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 2
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreUKey-19-3-latest-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 3
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreUKey-19-4-latest-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 4
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreUKey-19-5-latest-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 5
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreUKey-19-6-latest-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 6
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreUKey-19-7-latest-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 7
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreUKey-19-8-latest-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 8
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreUKey-19-9-latest-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 9
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreUKey-19-10-latest-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 10
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreUKey-19-11-latest-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 11
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreUKey-19-12-latest-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 12
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreUKey-19-13-latest-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 13
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreUKey-19-14-latest-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 14
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreUKey-19-15-latest-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 15
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreUKey-19-16-latest-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 16
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreUKey-19-17-latest-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 17
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreUKey-19-18-latest-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 18
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: webUIcoreUKey-19-19-latest-chrome-mysql8.0-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/encryption

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/encryption
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/encryption /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.2
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: setup-server-encryption
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e encryption
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: configure-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ encryption:enable
  - php occ encryption:select-encryption-type user-keys --yes
  - php occ config:list

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.4
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 19
    ENCRYPTION_TYPE: user-keys
    MAILHOG_HOST: email
    PLATFORM: Linux
    RUN_PART: 19
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mysql
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.2
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mysql-federated
  pull: always
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.2
- coding-standard-php7.3
- coding-standard-php7.4
- phpstan-php7.2

---
kind: pipeline
type: docker
name: chat-notifications

platform:
  os: linux
  arch: amd64

clone:
  disable: true

steps:
- name: notify-rocketchat
  pull: always
  image: plugins/slack:1
  settings:
    channel: builds
    webhook:
      from_secret: private_rocketchat

trigger:
  ref:
  - refs/tags/**
  - refs/heads/master
  status:
  - success
  - failure

depends_on:
- sonar-analysis
- cliEncryption-master-mysql8.0-php7.2
- cliEncryption-master-postgres9.4-php7.2
- cliEncryption-latest-mysql8.0-php7.2
- cliEncryption-latest-postgres9.4-php7.2
- apiMasterKeys-master-mysql8.0-php7.2
- apiMasterKeys-master-postgres9.4-php7.2
- apiMasterKeys-latest-mysql8.0-php7.2
- apiMasterKeys-latest-postgres9.4-php7.2
- webUIMasterKey-master-chrome-mysql8.0-php7.2
- webUIMasterKey-latest-chrome-mysql8.0-php7.2
- apiUserKeys-master-mysql8.0-php7.2
- apiUserKeys-master-postgres9.4-php7.2
- apiUserKeys-latest-mysql8.0-php7.2
- apiUserKeys-latest-postgres9.4-php7.2
- webUIUserKeys-master-chrome-mysql8.0-php7.2
- webUIUserKeys-latest-chrome-mysql8.0-php7.2
- apiCoreMKey-43-1-master-mysql8.0-php7.2
- apiCoreMKey-43-2-master-mysql8.0-php7.2
- apiCoreMKey-43-3-master-mysql8.0-php7.2
- apiCoreMKey-43-4-master-mysql8.0-php7.2
- apiCoreMKey-43-5-master-mysql8.0-php7.2
- apiCoreMKey-43-6-master-mysql8.0-php7.2
- apiCoreMKey-43-7-master-mysql8.0-php7.2
- apiCoreMKey-43-8-master-mysql8.0-php7.2
- apiCoreMKey-43-9-master-mysql8.0-php7.2
- apiCoreMKey-43-10-master-mysql8.0-php7.2
- apiCoreMKey-43-11-master-mysql8.0-php7.2
- apiCoreMKey-43-12-master-mysql8.0-php7.2
- apiCoreMKey-43-13-master-mysql8.0-php7.2
- apiCoreMKey-43-14-master-mysql8.0-php7.2
- apiCoreMKey-43-15-master-mysql8.0-php7.2
- apiCoreMKey-43-16-master-mysql8.0-php7.2
- apiCoreMKey-43-17-master-mysql8.0-php7.2
- apiCoreMKey-43-18-master-mysql8.0-php7.2
- apiCoreMKey-43-19-master-mysql8.0-php7.2
- apiCoreMKey-43-20-master-mysql8.0-php7.2
- apiCoreMKey-43-21-master-mysql8.0-php7.2
- apiCoreMKey-43-22-master-mysql8.0-php7.2
- apiCoreMKey-43-23-master-mysql8.0-php7.2
- apiCoreMKey-43-24-master-mysql8.0-php7.2
- apiCoreMKey-43-25-master-mysql8.0-php7.2
- apiCoreMKey-43-26-master-mysql8.0-php7.2
- apiCoreMKey-43-27-master-mysql8.0-php7.2
- apiCoreMKey-43-28-master-mysql8.0-php7.2
- apiCoreMKey-43-29-master-mysql8.0-php7.2
- apiCoreMKey-43-30-master-mysql8.0-php7.2
- apiCoreMKey-43-31-master-mysql8.0-php7.2
- apiCoreMKey-43-32-master-mysql8.0-php7.2
- apiCoreMKey-43-33-master-mysql8.0-php7.2
- apiCoreMKey-43-34-master-mysql8.0-php7.2
- apiCoreMKey-43-35-master-mysql8.0-php7.2
- apiCoreMKey-43-36-master-mysql8.0-php7.2
- apiCoreMKey-43-37-master-mysql8.0-php7.2
- apiCoreMKey-43-38-master-mysql8.0-php7.2
- apiCoreMKey-43-39-master-mysql8.0-php7.2
- apiCoreMKey-43-40-master-mysql8.0-php7.2
- apiCoreMKey-43-41-master-mysql8.0-php7.2
- apiCoreMKey-43-42-master-mysql8.0-php7.2
- apiCoreMKey-43-43-master-mysql8.0-php7.2
- apiCoreMKey-43-1-latest-mysql8.0-php7.2
- apiCoreMKey-43-2-latest-mysql8.0-php7.2
- apiCoreMKey-43-3-latest-mysql8.0-php7.2
- apiCoreMKey-43-4-latest-mysql8.0-php7.2
- apiCoreMKey-43-5-latest-mysql8.0-php7.2
- apiCoreMKey-43-6-latest-mysql8.0-php7.2
- apiCoreMKey-43-7-latest-mysql8.0-php7.2
- apiCoreMKey-43-8-latest-mysql8.0-php7.2
- apiCoreMKey-43-9-latest-mysql8.0-php7.2
- apiCoreMKey-43-10-latest-mysql8.0-php7.2
- apiCoreMKey-43-11-latest-mysql8.0-php7.2
- apiCoreMKey-43-12-latest-mysql8.0-php7.2
- apiCoreMKey-43-13-latest-mysql8.0-php7.2
- apiCoreMKey-43-14-latest-mysql8.0-php7.2
- apiCoreMKey-43-15-latest-mysql8.0-php7.2
- apiCoreMKey-43-16-latest-mysql8.0-php7.2
- apiCoreMKey-43-17-latest-mysql8.0-php7.2
- apiCoreMKey-43-18-latest-mysql8.0-php7.2
- apiCoreMKey-43-19-latest-mysql8.0-php7.2
- apiCoreMKey-43-20-latest-mysql8.0-php7.2
- apiCoreMKey-43-21-latest-mysql8.0-php7.2
- apiCoreMKey-43-22-latest-mysql8.0-php7.2
- apiCoreMKey-43-23-latest-mysql8.0-php7.2
- apiCoreMKey-43-24-latest-mysql8.0-php7.2
- apiCoreMKey-43-25-latest-mysql8.0-php7.2
- apiCoreMKey-43-26-latest-mysql8.0-php7.2
- apiCoreMKey-43-27-latest-mysql8.0-php7.2
- apiCoreMKey-43-28-latest-mysql8.0-php7.2
- apiCoreMKey-43-29-latest-mysql8.0-php7.2
- apiCoreMKey-43-30-latest-mysql8.0-php7.2
- apiCoreMKey-43-31-latest-mysql8.0-php7.2
- apiCoreMKey-43-32-latest-mysql8.0-php7.2
- apiCoreMKey-43-33-latest-mysql8.0-php7.2
- apiCoreMKey-43-34-latest-mysql8.0-php7.2
- apiCoreMKey-43-35-latest-mysql8.0-php7.2
- apiCoreMKey-43-36-latest-mysql8.0-php7.2
- apiCoreMKey-43-37-latest-mysql8.0-php7.2
- apiCoreMKey-43-38-latest-mysql8.0-php7.2
- apiCoreMKey-43-39-latest-mysql8.0-php7.2
- apiCoreMKey-43-40-latest-mysql8.0-php7.2
- apiCoreMKey-43-41-latest-mysql8.0-php7.2
- apiCoreMKey-43-42-latest-mysql8.0-php7.2
- apiCoreMKey-43-43-latest-mysql8.0-php7.2
- apiCoreUKey-43-1-master-mysql8.0-php7.2
- apiCoreUKey-43-2-master-mysql8.0-php7.2
- apiCoreUKey-43-3-master-mysql8.0-php7.2
- apiCoreUKey-43-4-master-mysql8.0-php7.2
- apiCoreUKey-43-5-master-mysql8.0-php7.2
- apiCoreUKey-43-6-master-mysql8.0-php7.2
- apiCoreUKey-43-7-master-mysql8.0-php7.2
- apiCoreUKey-43-8-master-mysql8.0-php7.2
- apiCoreUKey-43-9-master-mysql8.0-php7.2
- apiCoreUKey-43-10-master-mysql8.0-php7.2
- apiCoreUKey-43-11-master-mysql8.0-php7.2
- apiCoreUKey-43-12-master-mysql8.0-php7.2
- apiCoreUKey-43-13-master-mysql8.0-php7.2
- apiCoreUKey-43-14-master-mysql8.0-php7.2
- apiCoreUKey-43-15-master-mysql8.0-php7.2
- apiCoreUKey-43-16-master-mysql8.0-php7.2
- apiCoreUKey-43-17-master-mysql8.0-php7.2
- apiCoreUKey-43-18-master-mysql8.0-php7.2
- apiCoreUKey-43-19-master-mysql8.0-php7.2
- apiCoreUKey-43-20-master-mysql8.0-php7.2
- apiCoreUKey-43-21-master-mysql8.0-php7.2
- apiCoreUKey-43-22-master-mysql8.0-php7.2
- apiCoreUKey-43-23-master-mysql8.0-php7.2
- apiCoreUKey-43-24-master-mysql8.0-php7.2
- apiCoreUKey-43-25-master-mysql8.0-php7.2
- apiCoreUKey-43-26-master-mysql8.0-php7.2
- apiCoreUKey-43-27-master-mysql8.0-php7.2
- apiCoreUKey-43-28-master-mysql8.0-php7.2
- apiCoreUKey-43-29-master-mysql8.0-php7.2
- apiCoreUKey-43-30-master-mysql8.0-php7.2
- apiCoreUKey-43-31-master-mysql8.0-php7.2
- apiCoreUKey-43-32-master-mysql8.0-php7.2
- apiCoreUKey-43-33-master-mysql8.0-php7.2
- apiCoreUKey-43-34-master-mysql8.0-php7.2
- apiCoreUKey-43-35-master-mysql8.0-php7.2
- apiCoreUKey-43-36-master-mysql8.0-php7.2
- apiCoreUKey-43-37-master-mysql8.0-php7.2
- apiCoreUKey-43-38-master-mysql8.0-php7.2
- apiCoreUKey-43-39-master-mysql8.0-php7.2
- apiCoreUKey-43-40-master-mysql8.0-php7.2
- apiCoreUKey-43-41-master-mysql8.0-php7.2
- apiCoreUKey-43-42-master-mysql8.0-php7.2
- apiCoreUKey-43-43-master-mysql8.0-php7.2
- apiCoreUKey-43-1-latest-mysql8.0-php7.2
- apiCoreUKey-43-2-latest-mysql8.0-php7.2
- apiCoreUKey-43-3-latest-mysql8.0-php7.2
- apiCoreUKey-43-4-latest-mysql8.0-php7.2
- apiCoreUKey-43-5-latest-mysql8.0-php7.2
- apiCoreUKey-43-6-latest-mysql8.0-php7.2
- apiCoreUKey-43-7-latest-mysql8.0-php7.2
- apiCoreUKey-43-8-latest-mysql8.0-php7.2
- apiCoreUKey-43-9-latest-mysql8.0-php7.2
- apiCoreUKey-43-10-latest-mysql8.0-php7.2
- apiCoreUKey-43-11-latest-mysql8.0-php7.2
- apiCoreUKey-43-12-latest-mysql8.0-php7.2
- apiCoreUKey-43-13-latest-mysql8.0-php7.2
- apiCoreUKey-43-14-latest-mysql8.0-php7.2
- apiCoreUKey-43-15-latest-mysql8.0-php7.2
- apiCoreUKey-43-16-latest-mysql8.0-php7.2
- apiCoreUKey-43-17-latest-mysql8.0-php7.2
- apiCoreUKey-43-18-latest-mysql8.0-php7.2
- apiCoreUKey-43-19-latest-mysql8.0-php7.2
- apiCoreUKey-43-20-latest-mysql8.0-php7.2
- apiCoreUKey-43-21-latest-mysql8.0-php7.2
- apiCoreUKey-43-22-latest-mysql8.0-php7.2
- apiCoreUKey-43-23-latest-mysql8.0-php7.2
- apiCoreUKey-43-24-latest-mysql8.0-php7.2
- apiCoreUKey-43-25-latest-mysql8.0-php7.2
- apiCoreUKey-43-26-latest-mysql8.0-php7.2
- apiCoreUKey-43-27-latest-mysql8.0-php7.2
- apiCoreUKey-43-28-latest-mysql8.0-php7.2
- apiCoreUKey-43-29-latest-mysql8.0-php7.2
- apiCoreUKey-43-30-latest-mysql8.0-php7.2
- apiCoreUKey-43-31-latest-mysql8.0-php7.2
- apiCoreUKey-43-32-latest-mysql8.0-php7.2
- apiCoreUKey-43-33-latest-mysql8.0-php7.2
- apiCoreUKey-43-34-latest-mysql8.0-php7.2
- apiCoreUKey-43-35-latest-mysql8.0-php7.2
- apiCoreUKey-43-36-latest-mysql8.0-php7.2
- apiCoreUKey-43-37-latest-mysql8.0-php7.2
- apiCoreUKey-43-38-latest-mysql8.0-php7.2
- apiCoreUKey-43-39-latest-mysql8.0-php7.2
- apiCoreUKey-43-40-latest-mysql8.0-php7.2
- apiCoreUKey-43-41-latest-mysql8.0-php7.2
- apiCoreUKey-43-42-latest-mysql8.0-php7.2
- apiCoreUKey-43-43-latest-mysql8.0-php7.2
- cliCoreMKey-3-1-master-mysql8.0-php7.2
- cliCoreMKey-3-2-master-mysql8.0-php7.2
- cliCoreMKey-3-3-master-mysql8.0-php7.2
- cliCoreUKey-3-1-master-mysql8.0-php7.2
- cliCoreUKey-3-2-master-mysql8.0-php7.2
- cliCoreUKey-3-3-master-mysql8.0-php7.2
- webUIcoreMKey-19-1-master-chrome-mysql8.0-php7.2
- webUIcoreMKey-19-2-master-chrome-mysql8.0-php7.2
- webUIcoreMKey-19-3-master-chrome-mysql8.0-php7.2
- webUIcoreMKey-19-4-master-chrome-mysql8.0-php7.2
- webUIcoreMKey-19-5-master-chrome-mysql8.0-php7.2
- webUIcoreMKey-19-6-master-chrome-mysql8.0-php7.2
- webUIcoreMKey-19-7-master-chrome-mysql8.0-php7.2
- webUIcoreMKey-19-8-master-chrome-mysql8.0-php7.2
- webUIcoreMKey-19-9-master-chrome-mysql8.0-php7.2
- webUIcoreMKey-19-10-master-chrome-mysql8.0-php7.2
- webUIcoreMKey-19-11-master-chrome-mysql8.0-php7.2
- webUIcoreMKey-19-12-master-chrome-mysql8.0-php7.2
- webUIcoreMKey-19-13-master-chrome-mysql8.0-php7.2
- webUIcoreMKey-19-14-master-chrome-mysql8.0-php7.2
- webUIcoreMKey-19-15-master-chrome-mysql8.0-php7.2
- webUIcoreMKey-19-16-master-chrome-mysql8.0-php7.2
- webUIcoreMKey-19-17-master-chrome-mysql8.0-php7.2
- webUIcoreMKey-19-18-master-chrome-mysql8.0-php7.2
- webUIcoreMKey-19-19-master-chrome-mysql8.0-php7.2
- webUIcoreMKey-19-1-latest-chrome-mysql8.0-php7.2
- webUIcoreMKey-19-2-latest-chrome-mysql8.0-php7.2
- webUIcoreMKey-19-3-latest-chrome-mysql8.0-php7.2
- webUIcoreMKey-19-4-latest-chrome-mysql8.0-php7.2
- webUIcoreMKey-19-5-latest-chrome-mysql8.0-php7.2
- webUIcoreMKey-19-6-latest-chrome-mysql8.0-php7.2
- webUIcoreMKey-19-7-latest-chrome-mysql8.0-php7.2
- webUIcoreMKey-19-8-latest-chrome-mysql8.0-php7.2
- webUIcoreMKey-19-9-latest-chrome-mysql8.0-php7.2
- webUIcoreMKey-19-10-latest-chrome-mysql8.0-php7.2
- webUIcoreMKey-19-11-latest-chrome-mysql8.0-php7.2
- webUIcoreMKey-19-12-latest-chrome-mysql8.0-php7.2
- webUIcoreMKey-19-13-latest-chrome-mysql8.0-php7.2
- webUIcoreMKey-19-14-latest-chrome-mysql8.0-php7.2
- webUIcoreMKey-19-15-latest-chrome-mysql8.0-php7.2
- webUIcoreMKey-19-16-latest-chrome-mysql8.0-php7.2
- webUIcoreMKey-19-17-latest-chrome-mysql8.0-php7.2
- webUIcoreMKey-19-18-latest-chrome-mysql8.0-php7.2
- webUIcoreMKey-19-19-latest-chrome-mysql8.0-php7.2
- webUIcoreUKey-19-1-master-chrome-mysql8.0-php7.2
- webUIcoreUKey-19-2-master-chrome-mysql8.0-php7.2
- webUIcoreUKey-19-3-master-chrome-mysql8.0-php7.2
- webUIcoreUKey-19-4-master-chrome-mysql8.0-php7.2
- webUIcoreUKey-19-5-master-chrome-mysql8.0-php7.2
- webUIcoreUKey-19-6-master-chrome-mysql8.0-php7.2
- webUIcoreUKey-19-7-master-chrome-mysql8.0-php7.2
- webUIcoreUKey-19-8-master-chrome-mysql8.0-php7.2
- webUIcoreUKey-19-9-master-chrome-mysql8.0-php7.2
- webUIcoreUKey-19-10-master-chrome-mysql8.0-php7.2
- webUIcoreUKey-19-11-master-chrome-mysql8.0-php7.2
- webUIcoreUKey-19-12-master-chrome-mysql8.0-php7.2
- webUIcoreUKey-19-13-master-chrome-mysql8.0-php7.2
- webUIcoreUKey-19-14-master-chrome-mysql8.0-php7.2
- webUIcoreUKey-19-15-master-chrome-mysql8.0-php7.2
- webUIcoreUKey-19-16-master-chrome-mysql8.0-php7.2
- webUIcoreUKey-19-17-master-chrome-mysql8.0-php7.2
- webUIcoreUKey-19-18-master-chrome-mysql8.0-php7.2
- webUIcoreUKey-19-19-master-chrome-mysql8.0-php7.2
- webUIcoreUKey-19-1-latest-chrome-mysql8.0-php7.2
- webUIcoreUKey-19-2-latest-chrome-mysql8.0-php7.2
- webUIcoreUKey-19-3-latest-chrome-mysql8.0-php7.2
- webUIcoreUKey-19-4-latest-chrome-mysql8.0-php7.2
- webUIcoreUKey-19-5-latest-chrome-mysql8.0-php7.2
- webUIcoreUKey-19-6-latest-chrome-mysql8.0-php7.2
- webUIcoreUKey-19-7-latest-chrome-mysql8.0-php7.2
- webUIcoreUKey-19-8-latest-chrome-mysql8.0-php7.2
- webUIcoreUKey-19-9-latest-chrome-mysql8.0-php7.2
- webUIcoreUKey-19-10-latest-chrome-mysql8.0-php7.2
- webUIcoreUKey-19-11-latest-chrome-mysql8.0-php7.2
- webUIcoreUKey-19-12-latest-chrome-mysql8.0-php7.2
- webUIcoreUKey-19-13-latest-chrome-mysql8.0-php7.2
- webUIcoreUKey-19-14-latest-chrome-mysql8.0-php7.2
- webUIcoreUKey-19-15-latest-chrome-mysql8.0-php7.2
- webUIcoreUKey-19-16-latest-chrome-mysql8.0-php7.2
- webUIcoreUKey-19-17-latest-chrome-mysql8.0-php7.2
- webUIcoreUKey-19-18-latest-chrome-mysql8.0-php7.2
- webUIcoreUKey-19-19-latest-chrome-mysql8.0-php7.2

...
